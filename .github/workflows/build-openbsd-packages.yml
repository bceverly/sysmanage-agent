name: Build OpenBSD Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.9.9.8)'
        required: true
        default: '0.9.9.8'

permissions:
  contents: write

jobs:
  build-openbsd:
    name: Build OpenBSD ${{ matrix.openbsd-version }} Package
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        openbsd-version: ['7.7', '7.8']

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Build on OpenBSD ${{ matrix.openbsd-version }}
        uses: vmactions/openbsd-vm@2e29de1eb150dfe1c9c97b84ff2b7896f14ca690 # v1.2.5
        env:
          INPUT_OPENBSD_VERSION: ${{ matrix.openbsd-version }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        with:
          release: ${{ matrix.openbsd-version }}
          usesh: true
          sync: rsync
          run: |
            set -x

            OPENBSD_VERSION="$INPUT_OPENBSD_VERSION"
            OPENBSD_VERSION_NODOT=$(echo "$OPENBSD_VERSION" | tr -d '.')
            VERSION="$INPUT_VERSION"

            echo "=== Building sysmanage-agent ${VERSION} on OpenBSD ${OPENBSD_VERSION} ==="

            # Step 1: Fetch ports tree
            echo "=== Step 1: Fetching ports tree ==="
            cd /usr

            # Use ftp.openbsd.org which has older versions
            PORTS_URL="https://ftp.openbsd.org/pub/OpenBSD/${OPENBSD_VERSION}/ports.tar.gz"
            echo "Downloading ports from: $PORTS_URL"

            if ! ftp -o /tmp/ports.tar.gz "$PORTS_URL"; then
              echo "ERROR: Failed to download ports from $PORTS_URL"
              exit 1
            fi

            echo "Ports tarball downloaded:"
            ls -la /tmp/ports.tar.gz

            echo "Extracting full ports tree..."
            if ! tar xzf /tmp/ports.tar.gz -C /usr; then
              echo "ERROR: Failed to extract ports tarball"
              exit 1
            fi
            rm /tmp/ports.tar.gz

            echo "Ports extracted:"
            ls /usr/ports/

            # Step 2: Setup port directory
            echo "=== Step 2: Setting up port directory ==="
            mkdir -p /usr/ports/mystuff/sysutils/sysmanage-agent/files
            mkdir -p /usr/ports/mystuff/sysutils/sysmanage-agent/pkg

            # Copy port files
            cp $GITHUB_WORKSPACE/installer/openbsd/Makefile /usr/ports/mystuff/sysutils/sysmanage-agent/
            cp $GITHUB_WORKSPACE/installer/openbsd/distinfo /usr/ports/mystuff/sysutils/sysmanage-agent/
            cp -r $GITHUB_WORKSPACE/installer/openbsd/files/* /usr/ports/mystuff/sysutils/sysmanage-agent/files/ 2>/dev/null || true
            cp -r $GITHUB_WORKSPACE/installer/openbsd/pkg/* /usr/ports/mystuff/sysutils/sysmanage-agent/pkg/ 2>/dev/null || true

            # Update version in Makefile
            cd /usr/ports/mystuff/sysutils/sysmanage-agent
            sed -i "s/^GH_TAGNAME.*=.*/GH_TAGNAME = v${VERSION}/" Makefile
            sed -i "s/^REVISION.*=.*/REVISION = 0/" Makefile

            # Workaround for OpenBSD 7.6: The ports tarball is missing the lang/python/3 directory
            # but the Makefile references it. We fetch it from OpenBSD 7.5's ports tree.
            if [ "$OPENBSD_VERSION" = "7.6" ]; then
              echo "=== Applying OpenBSD 7.6 Python 3 workaround ==="
              echo "The 7.6 ports tarball is missing lang/python/3 directory."
              echo "Fetching Python 3.11 port from OpenBSD 7.5 ports tree..."

              cd /tmp
              PORTS75_URL="https://ftp.openbsd.org/pub/OpenBSD/7.5/ports.tar.gz"
              if ftp -o - "$PORTS75_URL" 2>/dev/null | gunzip | tar xf - ports/lang/python/3.11; then
                echo "Successfully extracted Python 3.11 port from 7.5"
                cp -R /tmp/ports/lang/python/3.11 /usr/ports/lang/python/3
                echo "Copied to /usr/ports/lang/python/3"
                ls -la /usr/ports/lang/python/
              else
                echo "ERROR: Failed to fetch Python 3.11 port from 7.5"
                exit 1
              fi

              cd /usr/ports/mystuff/sysutils/sysmanage-agent
            fi

            echo "=== Makefile contents ==="
            cat Makefile
            echo "========================="

            # Step 3: Generate checksums
            echo "=== Step 3: Generating checksums ==="
            make makesum 2>&1 || echo "makesum had warnings"
            echo "distinfo contents:"
            cat distinfo

            # Step 4: Build the package
            echo "=== Step 4: Building package ==="
            if ! make package 2>&1; then
              echo "ERROR: Package build failed"
              exit 1
            fi

            # Step 5: Find and copy the package
            echo "=== Step 5: Finding built package ==="
            find /usr/ports/packages -name "*.tgz" -type f 2>/dev/null || true

            PKG_FILE=$(find /usr/ports/packages -name "sysmanage-agent*.tgz" -type f 2>/dev/null | head -1)
            if [ -n "$PKG_FILE" ]; then
              cp "$PKG_FILE" "$GITHUB_WORKSPACE/sysmanage-agent-${VERSION}-openbsd${OPENBSD_VERSION_NODOT}.tgz"
              echo "SUCCESS: Package copied to workspace"
              ls -la $GITHUB_WORKSPACE/*.tgz
            else
              echo "ERROR: Package file not found!"
              find /usr/ports/packages -type f 2>/dev/null || echo "No files in /usr/ports/packages"
              exit 1
            fi

      - name: List built package
        run: |
          echo "=== Built packages in workspace ==="
          ls -la *.tgz 2>/dev/null || echo "No packages found"

      - name: Upload OpenBSD ${{ matrix.openbsd-version }} package
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: sysmanage-agent-openbsd-${{ matrix.openbsd-version }}
          path: "*.tgz"
          if-no-files-found: error

  # Job to collect all packages and create a summary
  collect-packages:
    name: Collect All Packages
    runs-on: ubuntu-latest
    needs: build-openbsd
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          path: packages/
        continue-on-error: true

      - name: List all packages
        run: |
          echo "=== All built packages ==="
          find packages/ -name "*.tgz" -type f 2>/dev/null || echo "No packages found"
          echo ""
          echo "=== Package details ==="
          for pkg in packages/*/*.tgz; do
            if [ -f "$pkg" ]; then
              echo "Package: $pkg"
              ls -lh "$pkg"
              echo ""
            fi
          done

      - name: Upload combined packages
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: hashFiles('packages/*/*.tgz') != ''
        with:
          name: sysmanage-agent-openbsd-all
          path: packages/
