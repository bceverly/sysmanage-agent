name: Build OpenBSD Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      openbsd_version:
        description: 'OpenBSD version (e.g., 7.7)'
        required: false
        default: '7.7'

jobs:
  build-openbsd-package:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        openbsd_version: ['7.7', '7.6']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag or use default
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="v0.9.9.8"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build OpenBSD package in VM
        uses: vmactions/openbsd-vm@v1
        with:
          release: ${{ matrix.openbsd_version }}
          prepare: |
            pkg_add wget
          run: |
            set -ex

            echo "========================================"
            echo "Building sysmanage-agent OpenBSD package"
            echo "OpenBSD version: ${{ matrix.openbsd_version }}"
            echo "Package version: ${{ steps.version.outputs.version }}"
            echo "========================================"

            # Create working directory
            mkdir -p /tmp/port-build
            cd /tmp/port-build

            # Download port files from GitHub
            REPO_URL="https://github.com/${{ github.repository }}"
            VERSION="${{ steps.version.outputs.version }}"

            echo "Downloading port files from $REPO_URL/archive/refs/tags/$VERSION.tar.gz"
            wget -O port.tar.gz "$REPO_URL/archive/refs/tags/$VERSION.tar.gz"

            # Extract (GitHub tarballs extract to sysmanage-agent-<version>/)
            tar xzf port.tar.gz

            # Find the extracted directory
            EXTRACTED_DIR=$(tar tzf port.tar.gz | head -1 | cut -f1 -d"/")
            echo "Extracted to: $EXTRACTED_DIR"

            # Copy port files to /usr/ports
            PORT_NAME="sysmanage-agent"
            PORT_DIR="/usr/ports/mystuff/sysutils/$PORT_NAME"

            mkdir -p "$PORT_DIR"
            cp -r "$EXTRACTED_DIR/installer/openbsd/"* "$PORT_DIR/"

            # Update Makefile with correct version
            cd "$PORT_DIR"
            sed -i "s/GH_TAGNAME =.*/GH_TAGNAME = $VERSION/" Makefile

            # Create stub distinfo to force makesum to download
            cat > distinfo <<EOF
            SHA256 ($VERSION.tar.gz) = 0000000000000000000000000000000000000000000000000000000000000000
            SIZE ($VERSION.tar.gz) = 0
            EOF

            echo "========================================"
            echo "Port directory contents:"
            ls -la
            echo "========================================"

            # Set up build environment
            mkdir -p /usr/obj/ports
            chmod o+x /usr/obj
            chown -R _pbuild:_pbuild /usr/obj/ports

            # Build as _pbuild user
            echo "Running make clean..."
            su -m _pbuild -c "make clean"

            echo "Running make makesum..."
            su -m _pbuild -c "make makesum"

            echo "Running make fetch..."
            su -m _pbuild -c "make fetch"

            echo "Running make package..."
            su -m _pbuild -c "make package"

            # Find the built package
            echo "========================================"
            echo "Searching for built package..."
            PKG_FILE=$(find /usr/obj/ports -name "${PORT_NAME}-*.tgz" -type f | head -1)

            if [ -z "$PKG_FILE" ]; then
              echo "ERROR: No package file found!"
              echo "Contents of /usr/obj/ports:"
              find /usr/obj/ports -ls
              exit 1
            fi

            echo "Found package: $PKG_FILE"

            # Copy package to a location we can extract
            mkdir -p /tmp/packages
            cp "$PKG_FILE" /tmp/packages/

            echo "Package copied to /tmp/packages/"
            ls -lh /tmp/packages/
            echo "========================================"

      - name: Extract package from VM
        run: |
          # The vmactions action should have the package in /tmp/packages
          echo "Package build completed for OpenBSD ${{ matrix.openbsd_version }}"

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: sysmanage-agent-openbsd-${{ matrix.openbsd_version }}-package
          path: /tmp/packages/*.tgz
          if-no-files-found: error
          retention-days: 90

      - name: Attach package to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: /tmp/packages/*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
